1. 网络  
组成元素：结点+链路。 
*** 
2. 互联网  
定义：网络的网络——多个网络以路由器为结点连接。  
***
3. 因特网   
最大的互联网  
***
4. 互联网（internet）和英特网（Internet)的区别  
互联网——各网络之间的通信协议任意。  
因特网——众多网络连接而成的**特定**网络，通信协议采用TCP/IP协议族。  
***
5. 单个网络ARPANET->三级结构因特网->多层次ISP结构因特网  
* 三级网：主干网、地区网、校园网  
* ISP（因特网服务提供者）：用户->ISP(提供成块的IP地址、通信线路、联网设备)  
我国的ISP：中国电信、移动、联通  

![001](https://i.loli.net/2021/10/11/41dcOKJxGq5Eerk.png)  
第二层是第一层ISP的用户，第三层是第二层ISP的用户  
***
6. 因特网标准化  
因特网所有RFC技术文档都可下载；  
ISOC：因特网协会；  
制定因特网标准：1.因特网草案 2.建议标准（RFC） 3.草案标准 4.因特网标准  
ps：RFC文档 != 因特网标准  
***
7. 因特网组成  
* 组成：边缘部分、核心部分  
* 边缘部分：用户直接使用，主机组成，各种设备  
  * 功能：资源共享、通信（传送各种类型数据）
* 核心部分：大量网络+路由器。
  * 功能：为边缘部分服务，提供连通性和交换。  
***
8. 路由器  
* 核心部分的核心组件
* 专用计算机，非主机
* 实现分组交换的关键之一
* 功能：转发收到的分组  
***
9. 交换方式  
* 电路交换  
  * 交换：动态分配传输线路资源  
  * 步骤：建立连接（分配通信资源） 通话（占用资源） 释放连接（归还通信资源）
  * 连接：电话A->用户线->交换机->中继线->交换机->用户线->电话B
  * 优点：通信时延小、有序传输、无冲突（物理信道不会被征用）、模拟数字信号都可以传输、实时性、简单。
  * 缺点：通信资源利用率低（通信线路即便空闲，也会因为建立连接被独占） 建立连接时间长、灵活性差（万一连接中断，需要建立新的连接）、难以规格化（不同终端难以通信；差错控制很难）
* 分组交换（电脑） 
  * 报文：一串要传输的数据   
  * 报文分组：小的等长数据段 +首部（包头）->分组  
  * 首部的作用：带有目的地址
  * 分组交换机（可能是路由器）作用：存储分组，查表转发，找转发接口，转到合适的交换机（总结：存储转发）
  * 报文分组到目的地之后，去首部->原始报文
  * 分组乱序：分组到达目的站顺序和发送顺序不同
  * 一个报文可以发给多个目的地址。
  * 分组丢失、误码、重复 **？？？**
  * 优点：不用建立连接，利用率高，存储管理方便、加速传输（后一个分组的存储和前一个分组的转发同时进行），减少出错概率和重发数据量
  * 缺点：转发时延；额外信息量；如果采用数据报服务：出现失序重复丢失；如果采用虚电路可以避免，但是需要呼叫建立、数据传输和电路释放。
  * **总结：**
    * 发送方:报文分组,发送分组 
    * 路由器：缓存，转发分组 
    * 接收方：接受分组 还原分组 
* 报文交换  
  * 电报通信网使用，对报文长度没有要求，因此需要较大的缓存空间。被分组交换取代。
  * 优点：不用建立连接；动态分配通信线路、传输可靠性增强（如果一条通信线路故障，可以换另一条线路）；线路利用率高；多目标服务
  * 缺点：具有转发时延、缓存量大，额外信息量（源地址，目标地址）
* **区别：**   
  * 电路交换需要建立连接；报文和分组交换不需要。  
  * 电路交换比特流直达终点；报文和分组则有转发时延（利于差错控制？？）  
![20211013142316](https://i.loli.net/2021/10/13/mybtUB6Y2Ek7OgF.png)
***
10. 分时操作系统（Time-sharing Operating System）  
* 一台计算机同时为几个、几十个甚至几百个用户服务的一种操作系统。  
* 它将系统处理机时间与内存空间按一定的时间间隔，轮流地切换给各终端用户的程序使用。其特点是可有效增加资源的使用率  
***
11. 网络分类  
传输技术：电路交换，报文交换，分组交换  
传输介质：  
* 有线：双绞线，光纤
* 无线：wifi  
覆盖范围：WAN（广域网，可以覆盖国家，国家网络之间的高速连接，因特网核心部分）、LAN（局域网，10Mbit/s，校园网）（路由器：1个WAN、多个LAN）、MAN（城市为企业、学校），个域网（手机、电脑互相连接）  
拓扑结构：
* 总线型：增加节点方便，线路节省 ；总线故障全网瘫痪。
* 星型： 中央设备：计算机 集线器 路由器；中央设备对故障敏感
* 环形：（令牌环局域网）环中信号单向传输。
* 网状：多用于广域网，可靠性高；控制复杂  
***
12. 网络性能指标  
共8个：  
* 速率 ：注意单位换算是10的三次方哦。
* 带宽：模拟信号中是一个频率范围，数字信号中表示通信线路传送数据的能力，即数据从一个点传到另一个点所能达到的最高数据率，也就是速率max；两者之间也有联系，带宽越宽，最高数据率越高。
* 吞吐量：可以理解成实际的平均速率
* 时延: 
  * 发送时延 = 数据量/传输速率；
  * 传播时延（包括了排队时延，还有这里呢，可能是包括了所谓的接受时延） = 节点距离/传播速度；
  * 处理时延（包括了排队时延）  难以计算  

ps ：在数据量很小的时候，发送时延占主导，当数据量大的时候通常传播时延占主导）（距离长）  
通常，铜线的通信速率是2.3x10^8m/s,光纤中是2x10^8m/s
* 时延带宽积：传播时延*带宽，以bit为单位的链路长度（这里忽略了发送时延）  
若发送端连续发送数据，则在所发送的第一个比特即将到达终点时，发送端就已经发送了时延带宽积个比特
* 往返时间（RTT）：源主机发送分组到源主机收到目的主机的确认分组为止的时间。
* 利用率： 
  * 信道利用率：某个通道百分之几的时间是被利用的（有数据通过）
  * 网络利用率：整个信道利用率的加权平均  
  ps：信道利用率越高越好嘛？  
  当然不是，信道利用率升高，时延增大。
  ![20211013173138](https://i.loli.net/2021/10/13/fW5SrtvJ78QEi2V.png)
* 丢包率：丢失的分组占总分组的比例。
  * 丢包事件：
    * 误码：传输过程中出错，被结点丢弃
    * 网络拥塞：结点队列满了，丢弃分组，但是一般在快满的时候，结点就会丢包了。
  * 丢包可以反映拥塞情况：
    * 无拥塞时路径丢包率为0
    * 轻度拥塞时路径丢包率为1%到4%
    * 严重拥塞时路径丢包率为5%到15%

***
13. 单位换算
* 容量：
![20211013154153](https://i.loli.net/2021/10/13/7Sv3NQTzJhU9M6s.png)  
ps：机械硬盘容量缩水因为日常用10的3次方，而实际计算机是2的10次方
* 速率：
![20211013161523](https://i.loli.net/2021/10/13/z4OuV2ImNxnTJWh.png)
***
14. 一个小问题：  
主机甲通过1 个路由器（存储转发方式）与主机乙互联，两段链路的数据传输速率均为10Mbps，主机甲分别采用报文交换和分组大小为 10 kb 的分组交换向主机乙发送 1 个大小为 8Mb（ 1M=106）的报文。 若忽略链路传播延迟、分组头开销和分组拆装时间， 则两种交换方式完成该报文传输所需的总时间分别为？  
1600ms，801ms（有一个路由器！！！！所以一个报文交换两个发送时延！！！）  
![20211013172844](https://i.loli.net/2021/10/13/atRfM6BVXbCWiK3.png)
***
15. 计算机网络体系结构
 * OSI开放系统互联体系结构
 * TCP/IP体系结构
 ![20211013234657](https://i.loli.net/2021/10/13/cmvNjRM5G1b9p2i.png)
网络接口层：为了适应不同的网络接口，比如以有线以太网接口，无线WiFi接口。（对应物理层和**数据**链路层）  
网际层：IP协议（核心）（互联不同网络接口、提供网络互连服务）  
运输层：TCP：可靠传输 UDP：不可靠传输  
应用层：HTTP（万维网应用），SMTP（电子邮件）（TCP）   DNS、RTP（UDP） FTP（文件传送）
* 一般路由器只有网络接口层和网际层。
***
16. 物理层
* 介质
* 物理接口
* 信号表示（何种信号表示比特）
***
17. 数据链路层
* 拓扑结构
* 如何标识主机（例如：总线型）->主机编址：MAC地址
* 从比特流划分地址和数据
* 主机争用总线问题  
总结：一个网络上传输的问题
***
18. 网络层（路由）（多个网络传输的问题）
* 表示**各个**网络和网络中的各主机（网络与主机共同编址，IP地址）（前三位标识网络+最后一位标识主机）
* 路由器转发分组，路由选择
19. 运输层（进程通信问题）
* 分组与应用进程对应的标识问题
* 传输错误（乱码+丢包）处理
![20211014111015](https://i.loli.net/2021/10/14/2N6sb97xUpVvWMO.png)
20. 应用进程之间的通信
例如：浏览器进程 和 Web服务器进程  
主机端：
* 应用层（http请求报文）
* 运输层（请求报文+tcp首部->tcp报文段）
* 网络层（tcp报文段+ip首部->可以被路由器转发）
* 数据链路层（ip数据报+首部+尾部->帧）首部使其能在网络上传输并被接受；尾部：目的主机检查其是否有误码
* 物理层：（前导码+帧->信号）目的：目的主机做好接受帧的准备 
路由器:
* 物理信号 比特流
* 去前导码 数据链路层
* 去首部尾部 网络层
* 解析ip数据报首部 提取目的网络地址 查找路由表 确定转发端口
服务器：
逐层解封发http响应报文。
***
21. 网络术语
实体：可发送/接受信息的硬件or软件进程。  
对等实体：相同层次中的实体（网卡、浏览器和服务器）
协议：控制两个对等实体进行**逻辑**（就是可以假设这两个实体在这一层通信，其他层不考虑）通信的规则。  
协议三要素：语法，语义，同步
服务
![20211014201625](https://i.loli.net/2021/10/14/GlWXtNLuZijsCK4.png)
22. 分组和时延问题  
假设要发送n个分组，每个分组都是 a 个bit，带宽为 b Mb/s,经过 m 段链路（也就是一共有m+1个节点），长度均为 l m，传输速率为 x m/s,求总时延。  
总时延 = a * n /(b * 10^6)(n个分组的发送时延) + m * l/x(m条链路的发送时延) + (m-1)* a/(b * 10^6)(怎么说呢，就是本来要n个分组的m个发送时延的但是因为重叠其中的（m-1）*n ->m-1)
![20211018214027](https://i.loli.net/2021/10/18/rneCSEa82dJWxzt.png)   
***
23. 物理层  
* 功能：解决如何表示比特流（即0和1的问题）
* 物理层协议主要任务：
   * 机械特性：接线器尺寸，引脚长什么样
   * 电气特性：电压范围
   * 功能特性：电压表示的意义
   * 过程特性：不同顺序导致的不同功能。
***
24. 传输媒体（物理层之下）  
* 分类：
  * 导引型：
    * 双绞线：
      * 无屏蔽双绞线（UTP）
      * 屏蔽双绞线（STP）：加了个金属保护层，抗外界干扰
      * 绞合的作用：
        * 减少外界电磁波干扰
        * 减少相邻导线的电磁干扰
    * 同轴电缆：内导体、绝缘层、屏蔽层、绝缘保护层。
      * 基带同轴电缆：数字传输，过去用于局域网（50欧阻抗）  
        集线器出现后，局域网使用双绞线。
      * 宽带同轴电缆：模拟传输，目前用于有线电视（75）
    * 光纤：
      
      * 分类： 
        * 多模光纤：脉冲展宽（近距离，建筑物内）
          * 传输方式：不断地全反射（入射角大于一个临界值）
          * 有脉冲展宽问题
          * 发光二级管+光电二极管
        * 单模光纤：不发生全反射
          * 长距离传输、衰减小
          * 激光器+激光检测
      * 优点：
        * 通信容量大：25000-30000Ghz带宽（怎么理解Ghz呢，请看下图）
        ![20211019002003](https://i.loli.net/2021/10/19/3R6PvoMhfrxOHmU.png)
        * 传输消耗少->远距离传输效果好
        * 抗雷电和电磁干扰
        * 无串音干扰，保密性好
        * 体积小，轻。
      * 缺点：
        * 贵
        * 割接困难
    * 电力线（电话线）
      * ……一般不能满足大量的需求

  * 非导引型：
    * 微波：常用2-40GHz   
      * 微波接力通信（终端之间有多个中继站放大信号）（wifi—）
      * 卫星通信（卫星作为中继站，传播时延在250-300ms之间）
    * 无线电波：地面波（中低频波）电离层反射（高频超高频）
    * 可见光：LIFI
    * 红外线：以前电脑有，现在有的手机有距离非常短，不能有障碍物。
***
25. 传输方式
* 串行传输  
  * 一条数据线：一个一个比特发送
* 并行传输  
  * n条线路：一次发送n个比特
  * 成本高  
**总结**：计算机之间串行，计算机内部（cpu与内存通过总线传输，总线宽度8,16,32,64位）并行传输。  
***
* 同步传输：字节连续传输，无间隔，稳定的比特流。
  * 时钟同步问题：发送端和接收端会有时钟误差的积累
    * 外同步：双方之间添加一条单独的时钟信号线
    * 内同步：在数据中使用一种时钟同步编码来实现（曼彻斯特编码）
* 异步传输：字节，一部分一部分的传递，各字节段之间的间隔不同
  * 同步方式：在每个字节的起始处实现同步。每个字节有起始位和结束位。
**总结**：同步和异步就是字节之间是否有间隔，间隔是怎样的
* 单向通信（单工）广播
* 双相交替（半双工）对讲机
* 双向同时（全双工）电话
26. 编码和调制  
* 数据--由网卡将0,1转变为电信号经过网线传输--基带信号（信源发出的原始信号）--编码---信道传输---
* 基带信号：
  * 数字基带信号：内存和cpu
  * 模拟~~~~~~~： 麦克风受到声音产生的信号
* 信道：
  * 数字
  * 模拟
* 编码：数字基带信号波形改变，但是是0的还是0,1还是1（仍然在数字信道传播）
* 调制：把数字基带信号转变为较高频率的信号，使之成为模拟信号
* 编码与调制的应用：
* 数字-数字：以太网：曼彻斯特编码、4B/5B、8B/10B
  * 数字-模拟：wifi 补码键控（cck。dss。ofdm）（补码键控，直接序列扩频，正交频分复用）
  * 模拟-数字：脉码调制pcm（采样量化编码-数字化）
  * 模拟-模拟：语音数据->载波信号（电话）；频分复用技术fdm（充分利用带宽）
* 码元：数字信号中，一个离散值的基本波形。
![20211019181419](https://i.loli.net/2021/10/19/5KwOsiJUqGnTxXz.png)
* 常用编码：
  * 不归0编码：在时间域内表示的码元不为0，要么正，要么负  
  Q:如何来判断一条水平线所包含的 码元的数量 呢？  
  A：额外传输线传输时钟信号。（太浪费了！！！）  
  * （诞生了！）归零编码：（图十分清晰）（半个正电平+0为1，半个负电平+0为0）
  ![20211019182502](https://i.loli.net/2021/10/19/MHY2ky1OdiZVUwT.png)
    * 优点：自同步
    * 缺点：数据带宽被浪费在时钟的编码上，所以编码效率低
  * （诞生了）曼彻斯特编码：
    * 正负跳变 表示0,1；表示时钟。
    * 用于传统以太网
  * 差分曼彻斯特编码：
    * 跳变表示时钟
    * 码元开始的电平是否变化表示数据。
    * 编码的变化比曼彻斯特少，适合较高传输速率
    ![20211019183717](https://i.loli.net/2021/10/19/tU2R3dcjoYMOLWy.png)  
**总结**
（加入了反向不归零编码，相同为0，不同为1）  
![20211019202428](https://i.loli.net/2021/10/19/Vgr74FOMCLYH3qZ.png)
***
27. 关于编码的小练习  
![20211019183906](https://i.loli.net/2021/10/19/6xmR5HAWQuEOUBn.png)  
Base--Mb/s T--双绞线
***
28. 关于调制  
三种方法：  
* 调频
* 调幅
* 调相
![20211019184253](https://i.loli.net/2021/10/19/NgDjr3MCfU1Zcmt.png) 
* 通过混合调制，能够使一个码元表示多个比特。
  * 频率和相位相关--只能调制其中一个
  * 相位与振幅一起调制：QAM（正交振幅调制）
  * 例如：QAM16
  ![20211019185228](https://i.loli.net/2021/10/19/BEH5u3WqRciGvPj.png)
  * 12种相位，每种相位对应1或2种振幅。共有16个码元可以选。
  * 所以每个码元能够对应4bit信息
  * 四个比特的信息不能随便定义，因为传输过程中会有失真，不能让它的错位太多。
  * 因此使用格雷码（相邻两个码元只有1比特不同）
29. 信道的极限容量   
码间串扰：分辨不出信号波形到底是0还是1.即信号失真    
影响因素：传输距离，信号干扰，传输媒体质量，**码元传输速率**与信号传播速度无关（传播时延）。  

**奈氏准则**：为了防止码间串扰，**码元传输速率**有限制。  
调制速率反映信号波形变换的频繁程度，其定义是每秒传输信号码元的个数，又称符号速率、码元速率或波特率，单位为波特
if 信号状态数 = x ，1个码元能代表的比特数为 log2x

![20211019190740](https://i.loli.net/2021/10/19/vMXS8KudarD7PJj.png)  
实际传输速率低于奈氏准则（理想条件下，忽略了噪声干扰以及传输媒体质量）  

**香农公式**：  
信噪比： 信噪比（DB） = 10 * log 10 （S/N ）
![20211019191456](https://i.loli.net/2021/10/19/PTAat2mnre7qXNg.png)  

**总结**：由香农和奈氏准则可以得出，提高数据传输速率（每秒数据量多少，更类似于发送时延中的带宽）需要 码元使用多元制（一个码元多个比特）、 加大信噪比

30. 数据链路层（点对点）  
单位：帧  
三个主要问题：  
* 封装成帧：帧头（目的+源+类型）+帧尾（FCS）  目的：以帧为单元传送数据
* 差错检测：接收方基于检错码发现（帧尾）
* 可靠传输：如果检测到误码，将该帧丢弃，并且要求发送方发送新的副本
  * 误码可以有，但是只要实现发送方发送什么，接收方就能收到什么，即为可靠传输
* 对于广播信道的数据链路层还有其他问题：
  * 编址问题
  * 信号碰撞（共享式局域网不可避免）---以太网媒体接入控制协议（csma/cd）
  * 交换式局域网 在有线领域 完全取代 共享式局域网  
  * 无线领域----广播信道（csma/ca）
  ![20211019205453](https://i.loli.net/2021/10/19/2uEb5SrfhlepKG4.png)

31. 封装成帧  
帧头帧尾功能：
* 含控制信息
* 帧定界（一头一尾1字节标志（ppp）），并不是所有的都有，比如以太网V2mac帧没有（而是在物理层添加8个字节前导码）
* 前导码：7个字节时钟同步 最后一个字节帧开始定界符 不需要结束定界符（有96bit帧间间距）  
透明传输：数据链路层对上层交付的传输数据没有任何限制，不管所传数据是什么样的比特组合，都应当能够在链路上传送，数据语义不变。
* Q：如果帧定界符的字段在上层交付的字段中出现该怎么办？
* A: （1）字节填充法 扫描，找出相应字段在字段前添加转义字符。当然万一其中有转义字符，那么也要在转义字符前添加转义字符。  
  （2）比特填充法，数据段，每五个1后添加一个0；（例如HDLC协议：帧首部01111110）
* 帧的最大传送单元MTU（考虑到差错控制而诞生的）（否则数据部分应该相比于帧头帧尾要尽可能大）

32. 差错检验  
* 比特差错：1--0,0--1
* 误码率（BER）：传输错的比特占比特总数的比例。
* 检验差错的方式：差错检测码（MAC帧--4bit帧尾FCS，PPP--2bit）  
* 差错类型：
  * 比特差错（数据链路层）
  * 分组丢失（上层）排队满了丢弃
  * 分组失序（上层）未按顺序到达接收端
  * 分组重复（上层）分组滞留导致超时重发
***
33. 奇偶校验  
奇校验：在传输的数据后面添加0,1（只添加一位），使数据中1的个数为奇数。  
优点：能检验一位出错  
缺点：不能检验偶数个位出错。
**总结**：奇偶校验均无法检测出偶数个位发生误码，容易漏检（不采用）  

34. 循环冗余校验CRC  
* 步骤：  
  1. 双方约定多项式g（x）
  2. 发送方计算冗余码
  3. 接收方通过多项式计算检验是否误码  
* 要求：需要有最低次项也就是最后一位是1.
（很难用语言描述，但是可以有例子）  
![20211021093506](https://i.loli.net/2021/10/21/pcT8LPAsqkJvfuE.png)  
* 计算方法：
  1. 构造被除数，被除数之后构造除数（也就是多项式）最高次数个0.（x的几次方，并非是有几位添几个0，而是几位-1）
  2. 构造除数
  3. 除法，一言难尽，总之是异或运算，如果说够除，也就是余数有三位，补一位即可，那么商为1，否则为0.看图。  
  4. 检查余数，余数和多项式最高次数相同。不够补0.
  ![20211021094310](https://i.loli.net/2021/10/21/vLy6kr27oRp9qZQ.png)
* **总结**：  
检错码只能在传输过程中检测出差错，但是不能纠正差错，也就是不能定位错误位置。  
优点：实现简单；漏检率低。
* ps：可以使用冗余信息更多的纠错码进行前向纠错，但是计算机网络不太用（开销大）  
计算机网络采用 检错重传（可靠） 或 丢弃差错帧（不可靠） 纠正差错  
***
35. 可靠传输  
数据链路层向上层提供的服务类型：
* 不可靠传输：丢弃误码帧
* 可靠传输：重传，实现发送端发啥，接收端接啥。  

* 有线传输：误码率低，为减小开销，不要求数据链路层向上层提供可靠传输，由上层处理。
* 无线链路： 数据链路层向上层**必须**提供可靠传输  

* 可靠传输不局限于数据链路层。
  * 无线局域网要求数据链路层实现可靠传输；以太网不要求。
  * IP即网际层，向上提供无连接，不可靠传输服务
  * TCP可靠，UDP无连接不可靠  
**总结**：可靠传输开销大，根据应用需求，决定是否使用可靠传输  
***
36. 可靠传输实现机制：
共三种，可以用在各层的可靠传输中：
* 停止等待协议SW：发送方发送一个分组，等待接收方接受分组，并且返回ack，才能将数据从缓存中删除，然后再发送下一个分组。如果分组产生误码，那么接收方发送NAK，发送方收到后，重传。
  * Q：数据丢失怎么办（数据链路层（点对点）出现的少，多个网络出现多。）  
  A：避免分组丢失：发送方发完一个分组，启动超时计时器（时间略大于平均往返时间）  
  * Q：那万一接受方的确认分组丢失了怎么办呢？（即接受方接受到了，之后会又收到一份相同的分组）  
  A：避免分组重复： 每个分组带上序号||对于停止等待协议，只要保证当前发送的分组和上次发送的分组是不同的就可以了，因此，只需要用一个比特来标记。  
  * Q:那么是不是确认分组也需要序号呢？  
  A:嗯。因为确认分组可能迟到。  
  ps：  
  * 数据链路层（点对点）往返时间固定，迟到的情况少。所以在数据链路层使用SW协议，不需要给确认分组编号。
  * 数据链路层重传时间容易设定（也就是超时计时器的时间），然而，运输层端到端的往返时间非常不确定---重传时间设置难  
![20211021135023](https://i.loli.net/2021/10/21/5rwyTektAvJjF7M.png)  
RTT越高，TD越小，信道利用率越低（卫星链路）
  * 停止等待协议：自动请求重传ARQ，因为不需要接收方的请求，发送方自动会重传。 
* 回退N帧协议GBN（流水线传输---滑动窗口协议）
  * 一个分组的确认分组还没收到，就继续发下一个分组。
  * 要确定的参数：
    * 多少个分组可以一起发（确认使用多少个bit给分组编号）-->发送窗口尺寸（尺寸为1为SW，发送窗口尺寸<=2<sup>n</sup>-1）
    * 接收方的窗口尺寸为1.
  * 机制：
    * 累计确认：不一定对每个分组都要发送确认（受到几个分组后）对按序到达的最后一个数据分组发送确认----确认分组丢失，发送方可能不用重传。
    * 重复确认： 如果接受方受到了误码，于是就一直向发送方发送前面的分组序号确认，发送方可以不等超时计时器超时，就立即重传误码分组（一个）。
    * 超时计时器（回退n帧）：如果超时，连续发送的**多个**分组将全部重传。
![20211021142243](https://i.loli.net/2021/10/21/CK2fuZaXrltFv98.png)  
  * 通信线路质量不好时，GBN与SW差不多（因为超时要重传整个分组。
* 选择重传协议（SR)
  * 滑动窗口参数：
    * 发送方：多个分组（滑动窗口尺寸：<=2<sup>n-1</sup>）(n为用几个比特表示分组序号)  
    ps：其实也是为了避免序号指向的分组不清的问题，主要也是因为接收方的确认分组发给发送方的时候丢失导致的，导致发送方滑动窗口没有移动，但是接收方的接收窗口已经移动到前面了。从而导致发送方超时重传的数和接收方滑动窗口指代的分组不同。
    如果说发送方序号为0-7，滑动窗口大小为8，接收方现在收到了0，于是0-7全部收齐了，发送一个累计确认，并且向前移动了一格，结果这个分组迟到了，于是发送方超时重传了0-7所有元素，那么这个0其实是之前的0，接收方滑动窗口的0，则是之后的0.
    * 接收方：多个分组（可以等于发送方窗口大小），可以收下失序但是没有误码的分组，所缺分组收齐后一并送交给上层。
  * 机制：
    * 接受方不能采取累计确认，而是**逐一**确认。
  * 目的：只重传丢失、出错分组。  
  这个过程很难描述：  
  如果接受方有一个分组没有接收到，这个分组会逐渐移动到滑动窗口的头部，同时发送窗口也是，一段时间后，发送窗口只需对这个分组重发即可。
 ![20211021154433](https://i.loli.net/2021/10/21/Lr26NMamVIuZeSJ.png)  
***
37. ppp协议，数据链路层最广泛的协议---点对点协议
* 应用：
  * 以太网：用户和ISP之间的以太网接入技术。
  * 路由器之间的广域网链路
* 构成部分：
  * 对各种协议数据报封装方法-->封装成帧
  * 链路控制协议LCP &emsp 建立、配制、测试数据链路连接（物理层,面向字节的异步链路，面向比特的同步链路）
  * 网络控制协议NCPs---每一个协议支持不同网络层协议（网络层，如IP,IPX,appletalk)
* 封装成帧 之 帧格式
  * ![20211021161137](https://i.loli.net/2021/10/21/mrkW78GRiSVBXqx.png)
  * 提供透明传输，不提供可靠传输：  
    * 面向字节的异步传输：
      * 遇到帧定界（7E）和转义（7D）：+7D 原数-OX20 变成4个16进制数字；  
      * 遇到控制字符（<=OX20）：：+7D 原数+OX20 
      ![20211021162439](https://i.loli.net/2021/10/21/Cx2eRljUuMHYq8d.png)
    * 面向比特的同步传输:5个1 1个0
* 工作方式：  
  ![20211021162855](https://i.loli.net/2021/10/21/sITN5WhYmjf4GrL.png)
***
38. 媒体接入控制（MAC）方式  
* 目的：协调多个发送和接收站点对一个传输媒体的占用。（共享）  
* 方式：
  * 静态划分信道
    * 频分、时分、码分（用于物理层，非数据链路层）
  * 动态划分信道
    * 受控（集中、分散）、随机接入（产生碰撞）  
  ps：有线领域--点对点+交换机---交换式局域网  
$~~~~~~~$无线局域网---广播特性---共享  
* **总结**：  
![20211021165749](https://i.loli.net/2021/10/21/brm7K4hdQoYJaFy.png)
 ***
39. 静态划分信道   
包括： 频分(FDM)、时分(TDM)、码分(CDM)、波分复用(WDM)
频分：不同频率，不同信号，每个频率，有隔离带，同时传输。  
时分：一个tdm帧不同信号拥有相同时间传输。然后循环。  
波分：就是光的频分复用。本来都是130nm的波长，通过光复用器，变成好多个纳米的波长，然后中间需要放大器（因为光会衰减）每120km放一个可放4个，在通过光分用器即可  
**码分**（CDMA）：DSSS（直接序列扩频）---每一个比特时间被继续划分成**码片**---mbit码片序列--m=64/128
![20211021193057](https://i.loli.net/2021/10/21/FqaZ1NeLg5TDluY.png)  
* 码片的使用原则：
  * 码片序列不同
  * 相互正交
* 复用和多址的区别：一个媒体的多个频段分给不同的信道；在同样时间频率下，多点接入，没有划分。
![20211021192738](https://i.loli.net/2021/10/21/DBezyaYZTt7L4io.png)  
***
40. 媒体接入控制->动态接入控制->随机接入    
* 早期以太网：**csma/cd**-----载波监听，多址接入，碰撞检测（有线，双绞线）
* 如今以太网：交换机，全双工，不适用CSMA/CD  
* ma多点接入：多个站点连接在一根总线上，竞争使用总线。  
*  cs载波监听: 先听后说，在发送数据之前，先看总线忙不忙，如果能检测到总线有96bit的空闲时间，那么就发送；反之则继续检验直到有96bit空闲为止。
   * 载波监听可以理解为在门口看车，不看远处就看前面。  
* cd碰撞检测：边说边听，发现碰撞，立即停止发送，等待一段时间后继续发送。  
* 以太网强化碰撞策略：一旦有站点检测到碰撞，除了立即停止发送数据部分，还会立即发送人为干扰信号（32bit，48bit）以便让所有站点都监测到信号
检测到碰撞是有次序的。  

**争用期**（碰撞窗口） 
![20211025104016](https://i.loli.net/2021/10/25/1K2OzNEhaSurBfF.png)  
争用期为2τ，也就是一个往返时间（这幅图中的δ指的是D发送时刻到τ时刻的时段）  
所以呢，意思就是，如果在争用期时间没有发生碰撞，那一定是没有发生碰撞了（这好像是废话呢）  
那么这个τ怎么确定呢，当然是端到端的传播距离了（当然还和传输媒介有关）  
碰撞发生的概率：主机越多，端到端之间的传播时延越大，那么就越容易发生碰撞。  
* 以太网总线型：**总线长度**不能太长，**主机数量**不能太多。  
比如10Mb/s以太网，争用期为512比特发送时间，也就是51.2微秒，如果按照传输速度是2*10<sup>8</sup>m/s那么总线长为5120m，由于信号衰减，最后决定总线不超过2500m。  

**最小帧长**  
* 为什么要规定最小帧长呢？  
  假设a主机发一个很短的帧，很快就发完了，然后在这个传递的过程中，主机c检测到96bit空闲于是就发送了，结果和a帧相撞了，此时a帧肯定是无法停止的，c会把碰撞的数据插入a帧中，于是d帧受到之后肯定会检测出错，于是丢弃，但是对于a帧来说，他并不知道，在它碰撞检测的过程中没有检测到碰撞，所以不会再次发送。
* 以太网规定：512bit（64字节）（512bit时间即为争用期）（少于64bit----填充）
* 最小帧长的作用：
  * 如果碰撞，那么长度小于64字节，为无效帧
  * 不碰撞，后续数据也不会碰撞  

**最大帧长**
* 意义：占用总线；接收端的缓冲区满。
* 1500字节左右吧。  

**阶段二进制指数退避算法**
* 退避时间 = 2τ*随机数r（0,1，。。。2<sup>k</sup>-1)k为重传次数与10较小的那个，if k > 16 丢弃。（说明发送帧的主机太多，连续发生碰撞）
* 退避时间的意义：重传的平均时间随重传次数逐渐变大（动态退避）来减小发生碰撞的概率，利于系统稳定。  

**信道利用率**  
一次帧的发送成功包括：多次碰撞而造成的多次退避（n*2τ）+发送时延T0+传播时延τ  
![20211025152336](https://i.loli.net/2021/10/25/UAwgL2mqFVTxk3B.png)  

**帧的发送和接收**
![20211025152747](https://i.loli.net/2021/10/25/AyJ3GXpkQ6LP4ex.png)  
![20211025152817](https://i.loli.net/2021/10/25/tIirdHgo8sh5y7W.png)

**小练习**
![20211025153949](https://i.loli.net/2021/10/25/cGfYHtpu42jEVaM.png)  
***
41. csma/ca(无线)
* 载波监听+碰撞避免
* Q：为什么不能使用碰撞检测（CD）？   
  A：碰撞处的信号很大，然而信号强度在网卡接收到时非常小（能相差几百万倍）；隐蔽站问题（a和c互相检测不到对方，认为信道是空闲的，发送给中间的b从而碰撞）  
  ![20211025161546](https://i.loli.net/2021/10/25/XNKG9kOyYS8TeVU.png)  
* 802.11无线局域网---csma/ca---无线，误码率高，不能避免碰撞---数据链路层使用SW协议
* dcf---无中心控制，pcf---有控制点（很少使用）
* ![20211025162321](https://i.loli.net/2021/10/25/gb8VGSDLuNoJQiB.png)
* 802.11规定：帧间间隔IFS---要发送帧，先要检测到信道上有一段空闲的时间。
  * 高优先级帧、低优先级帧
  * SIFS短帧间间隔（28微秒）：站点能够从发送状态变为接受状态
  * DCF帧间间隔（DIFS）（128微秒）：数据帧、管理帧之间  
  ![20211025163255](https://i.loli.net/2021/10/25/S8AZgGuDQx47OTo.png)  
* 帧间间隔的具体案例：  
![20211025163711](https://i.loli.net/2021/10/25/ydc9b8kZqoTejni.png)  
  * 首先，为什么需要源站的DIFS，因为需要保证没有**优先级**比他高的帧发送。
  * sifs呢？一次会话最短的帧间间隔，这样能保证站从接收变为发送态。
  * 其他站的随机时间，为的是防止多个站点同时发送数据。
  * **退避算法**
  * 那么又要问了，源站这里咋就判断不适用退避算法呢？
    * 退避算法的应用场景：
      * if （信道空闲 && 当前数据帧！= 上次数据帧的延续） {
        不调用退避算法
      }
      * if （信道之前忙 || 当前数据帧 == 上次数据帧的延续（这些其实就是上面的取反））{
        调用退避算法
      }
      * if 重传某个帧{
        调用退避算法
      }
    * 关于数据帧为什么连续就要等待随机时间。。。因为避免某个站点数据长时间占据信道。
  * 退避算法原理：  
  ![20211025165250](https://i.loli.net/2021/10/25/lIZ4K5f3ckTQhP2.png)  
* csma/ca协议的信道预约和虚拟载波监听
  * **信道预约**
  * RTS（请求发送）和CTS（允许发送）
  * RTS---持续时间。源地址。目的地址
  * CTS---持续时间。
  * ![20211025181013](https://i.loli.net/2021/10/25/iSWVt4DcRTLyMkg.png)  
  * **虚拟载波监听**
  * 数据帧携带信道占用时间
  * 意义：只要站点监听到RTS、CTS、数据帧中的任何一个，就能知道信道被占用的时间，因此可以减少隐蔽站碰撞。

***
42. MAC地址、IP地址、ARP协议
ip、arp---网际层; mac地址----数据链路层  

**MAC地址**：数据链路层 唯一的标识  
位置：固化在网卡ROM中---硬件地址；物理地址  
![20211026165647](https://i.loli.net/2021/10/26/H7uCyvJOlwn1fTo.png)  
实际应用：
* 用户主机一般会有两个网络适配器（网卡），有线和无线。
每个网络适配器有全球唯一MAC地址。
* 交换机、路由器有更多接口->有更多MAC地址。
* 所以，MAC是网络上各接口的唯一标识----而非是各设备的唯一标识。
* MAC地址格式（IE802局域网）    
![20211026173810](https://i.loli.net/2021/10/26/cisFAtvlLUw5T8E.png)  
  * OUI（3B) + 网络接口标识（3B) = EUI-48
  * 4个bit表示一个十六进制数 ---12个字符--2个字符一组---windows 横线；linux，apple，安卓 冒号
  * 在第一个字节的b0，b1位置分别会确定单播和多播（也就是16进制中那些不能被2整除的数），全球管理还是本地管理。
  * 发送顺序是从第1->第6字节;然后从b0->b7
  * 多播需要在多播组列表查询，如果有就能接受。
*** 
43. IP地址
* 组成：网络编号+主机编号
* 功能：区分网络
   * 单独网络（不接入网络）----可以只用MAC地址
   * 接入因特网---ip地址+MAC地址
* 网络传输过程：
  * IP地址：保持 源地址->目的地址
  * MAC地址：当前MAC地址->下一个目的的MAC地址(改变状态)
* 这里假设：各台主机之间是知道对方的IP地址的，但是并不知道对方的MAC地址。那么问题来了，如何知道对方的MAC地址呢？
* 首先当主机需要向其他主机发送数据包时，先检查ARP高速缓存表，若没有，发送**ARP请求报文**（被封装在MAC帧中发送，包括本主机的IP，MAC，和想要获取的主机的IP），目的地址---**广播地址**，然后，其他主机如果发现是自己的IP地址，就会发送**ARP响应报文**，将MAC地址以**单播**的形式给源主机，源主机会将该主机的IP，MAC记录在ARP高速缓存表中。![20211026213003](https://i.loli.net/2021/10/26/VyxMsF2PXADqt3E.png)  
* ARP高速缓存表：
  * IP地址
  * MAC地址
  * 类型
    * 静态：手工设置，不同操作系统周期不同，有重启后清除或不清除
    * 动态：主机自动获取，生命周期2min
* ARP协议的适用范围：
  * 只能在一段链路上使用ARP，因为要携带MAC地址，不能在多段链路上使用。
* ps：还有其他arp相关报文，如检查ip地址冲突的无故/免费ARP；arp没有安全验证，存在ARP欺骗和攻击

44. 集线器和交换机
* 历史：同轴电缆---双绞线+集线器
* 双绞线+**集线器**：
  * 物理：星型
  * 逻辑：总线型 
  * **集线器HUB**：物理层
    * 接口功能：转发比特，不进行碰撞检测----站点网卡检测
    * 逻辑：一条总线
    * 工作方式：将单播帧发送给所有与集线器相连的主机，然后看主机接不接收。使用CSMA/CD。半双工（收发帧不同时进行）。
    * 总功能：有少量容错能力和网络管理能力
      * eg网卡故障导致不断发送帧，集线器能检测并断开网卡连线。
    * 本质：扩大碰撞域，扩大广播域
* **交换机SWITCH**：数据链路层（也有包含网络层的三层交换机）
  * 工作方式：将单播帧仅发送给目的主机。全双工。多个接口连接主机或交换机。多对接口同时连接---并行性，无碰撞，不适用CSMA/CD
  * 工作原理：1.建立帧交换表（自学习算法） 2.将帧的目的主机MAC地址和接口号对应 
  * 帧的转发方式：
    * 存储转发（缓存逐个转发）
    * 直通交换（不用缓存再处理，不检查帧是否有差错）硬件交叉矩阵，时延小。
  * 本质：隔离碰撞域，不隔离广播域（VLAN除外）

45. 交换机的自学习算法原理
* 假设每个主机已知其他主机的MAC地址。
* 过程：
  * 一个空的帧交换表。主机A要给主机B发送数据。
  * 帧交换表中放入主机A的MAC地址和对应的接口（登记）。
  * 查找目的主机B的MAC地址，发现没有。
  * 盲目转发（泛洪），从除了源主机接入接口外的接口向其他所有主机转发。
  * 交换机与交换机互连的地方，也会将主机A在另一台的交换机接口号和MAC地址记录在交换机中（登记）。
  * **丢弃帧的情况：**假设A与G通过集线器相连，那么当A向G发送数据时，A会给G也会给交换机发送数据，交换机接收到数据后，发现G对应的接口号和A相同，所以不需要转发，便丢弃该帧。
* 性质：每条记录都会经过一定时间，到期删除。为什么呢？
  * 和ARP缓存表一样，因为接口和MAC地址不是永久对应的，例如换了主机，网卡都可能改变。
* PDU协议数据单元---对等实体的逻辑通信对象
46. 以太网交换机的生成树协议STP
* Q：如何提高以太网可靠性？（某个交换机故障导致连接障碍）
* A：冗余链路
  * 负面效果：网络环路。
  * 广播风暴：大量消耗网络资源无法转发其他帧
  * 主机受到重复帧——消耗主机资源
  * 交换机的帧交换表震荡漂移
  * 结论：不行
* **生成树协议**
  * 目的：保证可靠性；避免网络环路
  * 构建原则：
    * 没有逻辑环路————树型
  * 解释：物理上有许多冗余链路；但是各链路分为：阻塞，故障，连通。
  连通状态的链路是树型的。由于人为或故障导致的物理链路改造，交换机会自己通过生成树算法重新构造新的链路。
46. VLAN虚拟局域网    
* 广播域的扩大会带来很多问题：
  * 广播风暴
  * 占用主机和网络资源  
![20211028213530](https://i.loli.net/2021/10/28/IQgJdlWqSFsVjon.png)  
* 分隔广播域的方法：
  * 路由器————默认情况：不对广播数据包转发
    * 成本高，全部使用不现实
  * 虚拟局域网技术VLAN
47. VLAN实现机制  
* 实现设备：交换机
* 实现要求： 
  * 帧带有VLAN标记——IEEE 802.1Q帧
  * 交换机有不同接口类型
* IEEE 802.1Q帧
  * MAC帧格式扩展——插入4字节VLAN标记
  * VLAN标记的最后12bit 叫 VID——唯一标记以太网帧属于哪个VLAN 
  * 取值范围：0-4095，有效取值范围：1-4094 
  * 802.1Q帧是由交换机处理的，而非主机。
    * 交换机受到普通以太网帧，对其插入4字节标记---打标签
    * 交换机转发802.1Q帧时，可能删除4B~~~~~~~----去标签
  ![20211028215127](https://i.loli.net/2021/10/28/SspdAiqmVUFcQIu.png)   
* 交换机的端口类型
  * access
    * 连接用户计算机
    * 只属于一个VLAN
    * PVID与端口的VLAN的ID相同
    * 处理方法：
      * 只接受未打标签的MAC帧---打标签
      * 发送时，VID与PVID相等---去标签转发，否则不转发。
    ![20211028230757](https://i.loli.net/2021/10/28/1bpCOuwAoTYSqNL.png)
  * trunk
    * 连接交换机和交换机或路由器
  ![20211028231147](https://i.loli.net/2021/10/28/lJtwVkHShp6fUPz.png)
    * 互连端口trunk值不同，可能会造成转发错误
  * hybrid  
    * ![20211028232037](https://i.loli.net/2021/10/28/QGWqFYIfe85BaRM.png)  
***
48. 网络层  
* 因特网TCP/IP协议体系————不可靠无连接传输  
* 网络层功能：
  * 网络层--运输层提供的服务---可靠/不可靠
  * 网络层寻址
  * 路由选择
* 网际层：
  * 包括：网际协议IP，ARP，ICMP，IGMP
***
49. 网络层服务  
* 面向连接：虚电路服务
  * 可靠---网络保证（无差错、不丢、不重、有序）
  * 通过建立的虚电报发送分组
  * 目的地址----连接建立需要；虚电路编号----分组首部
  * 通信结束，释放虚电路。
  * 异步传输ATM
* 无连接：数据报服务  
  * 网络不负责可靠通信，主机负责
  * 不用建立连接
  * 分组可走不同路径
  * 首部有完整主机地址
  * 路由器简单
  * 复杂网络处理---因特网边缘（主机和运输层）
  * 主要针对分组交付的简单实现
![20211029090330](https://i.loli.net/2021/10/29/hcrYyTaqBo9GPtA.png)  
***
50.IPv4地址  
* 32bit 唯一 主机或路由器接口的标识符
* 历史：分类编址，划分子网，无分类编址
***
51.分类编址  
|类型|网络号 + 主机号 | 首位|
|:---: | :---:| :---:|
A:| 8+24| 0|
B:| 16+16|10
C:| 24+8 |110
D: |多播地址 |1110
E:|保留之后使用|1111

* abc类地址可以分配给主机、路由器接口
* **主机号**全0---网络地址；**主机号**全1---广播地址
* a类地址（最高位0）：
  * 最小网络号：全0---不指派-------1.0.0.0
  * 最大网络号：127----本地环回测试地址，不指派
    * 最小本地换回测试地址：127.0.0.1
    * 最大~~~~~~~~~~~~~~~：127.255.255.254
  * 可指派的网络数量：1-126 共126个（首位为0，去全0和全1）
  * 一个网络中的IP地址数量：2<sup>24</sup>-2（去全0,全1）
* b类地址（最高位10）：
  * 最小网络号：128.0即10000000,00000000；网络地址：128.0.0.0
  * 最大网络号:191.255即10111111,1111111；网络地址191.255.0.0
  * 可指派网络数量：2<sup>(16-2)</sup> 
  * 一个网络中的IP地址数量：2<sup>16</sup>-2 = 65534
* c类地址：
  * 最小网络号：192.0.0即11000000,00000000,00000000
  * 最大网络号：223.255.255即11011111,11111111,11111111
  * 可指派网络数量：2<sup>(24-3)</sup>
  * 一个网络中的IP地址数量：2<sup>8</sup>-2 = 254
* 0.0.0.0：
  * 在本网络上的本主机
  * 只能作为源地址，不能作为目的地址
* 127.0.0.1-127.255.255.254：
  * 本地软件环回测试使用
  * 可以作为源地址，可以作为目的地址
* 255.255.255.255：
  * 只作为目的地址---只在本网络广播（路由器不转发）  ![20211029101727](https://i.loli.net/2021/10/29/6CIjDkgwV1rtNoc.png)  
  ![20211029102120](https://i.loli.net/2021/10/29/5nlZabD7AERiWh4.png)  
***
52. 划分子网  
* 诞生：
  * b类地址一个网络能够连接的主机或接口数量：65534；
  * c类地址~~~~~~~~~~~~~~~~~~~~~~~~~~~~~：254；
  * 数量相差太多了！能不能对一个b类地址合理利用呢？
  * 子网掩码诞生！！！
* 概况： 
  * 32bit
  * 连续的1---网络号+子网号
  * 连续的0---主机号  
  ![20211029104638](https://i.loli.net/2021/10/29/Pp4ZQxShesKb8Vv.png)  
  * 默认的子网掩码：未划分子网时的子网掩码
* DHCP协议：应用层协议
  * 动态主机配制协议，允许主机自动获取一个IP地址
***
53. 无分类编址  
无分类域间路由选择CIDR(classless inter-domain routing)  
* 规则：128.14.35.7/20---前20位网络号，后12位主机号
* ![20211029164231](https://i.loli.net/2021/10/29/2luwAeOyqUxbdan.png)
* 路由聚合：
  * ![20211029164629](https://i.loli.net/2021/10/29/C7a3BJIYTilfudH.png)
  * 意义：把具有相同前缀的主机连着的同一个路由放在一条写。
***
54. 定长子网掩码FLSM 变长子网掩码VLSM
* 定长子网掩码：
  * 从主机号部分借几位作为子网，一般为2<sup>n</sup>个子网
  * 每个子网的IP地址数量相同。
  * 容易造成IP地址的浪费。
* 变长子网掩码：
  * 首先根据每个网络需要的主机数确定各个网络的网络号+子网号位数---这一步确定的是子网掩码
  * 之后一般会从需要的多的主机数的网络从0开始编，否则的话，为了合适的广播地址，会浪费，此时对于同一个网络，子网掩码仍然是相同的，子网号也是相同的。
  * ![20211029172257](https://i.loli.net/2021/10/29/aICAB1wpYZ4GkTO.png)  
***
55. IP数据报的发送与转发  

分为两个部分：
* 主机发送IP数据报
* 路由转发  

举个例子：  
* ![20211029194306](https://i.loli.net/2021/10/29/AL7cBkp1YeqOodJ.png)   
* 主机c与主机f之间要传递数据。主机c与ab之间是直接交付，而对f是间接交付
* Q1：主机C如何判断f与其不在一个网络呢？
* A1：由于C知道f的IP地址，于是通过将f的IP地址，与自己网络的子网掩码相与，发现并不是自己网络的网络地址，便知道主机f不在自己的网络中。
* Q2：那么c是怎么知道发给哪个路由器的呢？
* A2：每个主机在一开始都有一个默认网关，也就是某个路由器的接口。
* Q3: 路由器接收到数据报后要做什么？
* A3：1、检查IP首部有没有错---出错丢弃通告源主机（icmp差错报告报文）；不出错转发 2.根据路由表（包括了网络地址，子网掩码，和下一跳（接口））转发，如果没有则丢弃。

n个网桥 = 1个交换机
***
56. 静态路由配置  
* 优点：人工配制路由表——简单，开销小。
* 缺点：小网络；不能适应网络状态（流量，拓扑）问题
* 产生路由环路问题：配置错误；聚合不存在网络；网络故障
  * 配制错误：顺序：c a b
    * a->b->a 不断循环 由于路由器a应该给路由器c的但是配制错了，导致不断循环，产生路由环路。
    * 解决方法：设置TTL，每当进入路由器TTL-1，if TTL == 0，丢弃IP数据报。
  * 聚合不存在网络
    * 由于其他路由找不到该地址，于是通过默认路由，由转发给原来的路由器，导致环路
    * 解决方法：在原来的路由器转发时配制黑洞路由，黑洞路由的下一跳为null（虚拟接口），这个地址IP数据报会被丢弃
  * 网络故障
    * 故障的地址连接在路由表中被删除了，于是通过默认路由，又一次形成了路由环路。
    * 解决方法：在转发到的路由器（连接故障网络IP地址的路由器）设置黑洞路由，即那个故障IP的下一跳为null（人工）然后如果生效了，则会使这条黑洞路由失效，当又出现故障时生效。
* 路由配置：
  * 直连：接口与网络直接连接；如果检测到不可达会直接删除
  * 静态：人工配置——IP地址为目的地址（不是接口的地址），下一跳的地址为另一个路由的接口地址。
    * 默认：0.0.0.0 /0 地址掩码：0.0.0.0  存在意义：如果有许多网络地址，其指向的下一跳都是同一个接口地址，那么就可以用一条默认来代替n条，类型为静态。 网络前缀最短，路由最模糊。
    * 特定主机路由：针对网络管理和测试，类型为静态（网络前缀32，路由最具体）  
* 有多条路由可选时，选择路由最具体的即网络前缀最长。
***
57. 路由选择协议  
* 因特网路由选择的特点：
  * 分层次
    * 域间路由选择
      * 外部网关协议EGP(这不是具体的协议)
    * 域内路由选择
      * 内部网关协议IGP(这不是具体的协议)
  ![20211029231910](https://i.loli.net/2021/10/29/HkczbKqIjaMwFC2.png)
  * 自制系统AS
  * 自适性
* 路由器结构：
  * 输入/出端口
  * 输入/出缓冲区
  * 路由选择处理机
  * 路由表/转发表
* 路由器工作模式：
  * 如果分组内容为数据：---之前说过了
  * 如果分组是路由器之间交换路由信息的路由报文：
    * 转交--路由选择处理机---路由表
    * 路由表功能：
      * 目的地址----下一跳
      * 网络拓扑优化
      * 周期发送路由信息
    * 转发表
      * 由路由表得出
      * 查找优化
58. 路由信息协议RIP（IGP）
* 内容：每一个路由器需要维护从自己到AS内其他每一个网络的距离————距离向量D-V
* 距离度量单位：跳数
* 路由器-直连网络距离：1
* 路由器-非直连网络距离：路由器数+1
* 一条路径最多15个路由器，即路径最大值16.
* 适用范围：小型互联网
* “好路由”：路由器少的；
  * 如果两条链路路由器数量相等---等价负载均衡（通信量平摊）
* 要点：
  * 和谁交换信息：相邻路由器
  * 交换什么信息：路由表
  * 多久交换~~~~：周期性交换（如30s一次）
* RIP工作过程
  * 一开始，只有直连网络距离为1
  * 仅和相邻路由器周期性交换信息
  * 几次后各路由器知道AS内各个网络的最短距离和下一跳地址----收敛。
* 基于RIP的路由条目更新规则
  * 更新：
    * 到达已有的目的网络，相同下一跳，最新信息（无论长度，因为拓扑结构发生变化），更新
    * 新的网络，添加
    * 到达已有的目的网络，不同下一跳，新路由短，更新替换
    * 到达已有的目的网络，不同下一跳，新路由一样长，添加（等价负载均衡）
  * 不更新：
    * 到达已有的目的网络，不同下一跳，新路由长，不更新
* “坏消息传得慢”：
  * 出现路由环路导致的，23456……………16 两个路由表只有都到16时才会知道某个网络故障。
  * 解决方法：
    * 限制最大路径为15，16不可达
    * 路由表更新就立即发送更新报文---而非再继续周期性发送
    * 路由器收到路由信息的接口，不再反方向传送（水平分割）
  * 但是仍然无法解决路由环路
***
59. 开放最短路径优先OSPF
* 原理：
  * 最短路径算法
  * 基于链路状态，而非向量
    * 链路状态：相邻路由器，费用距离带宽等等
* 特点：
  * 不产生路由环路
  * 不限制网络规模，更新快，收敛快。
* 结构
  * ![20211030201157](https://i.loli.net/2021/10/30/UVEGMsyBK6NolDZ.png)
* 工作原理：
  * 相邻路由器：问候分组（IP数据包）---组播地址发送224.0.0.5（D类）
  * 邻居表：
    * 发送周期10s
    * 死亡倒计时40s，>40s不可达
  * 链路状态通告LSA：
    * 内容：
      * 直联网络链路状态信息
      * 邻居路由器~~~~~~~~
    * 位置：
      * 链路状态更新分组LSU中
    * 发送方式：
      * 洪泛法发送（除了接受端口，其余端口都发送）
  * 链路状态数据库（LSDB）
    * 功能：
      * 存储LSA
  * 路由表：
    * 通过LSDB使用最短路径算法得到以各路由器为根的带权有向图 
* OSPF分组类型（5种）
  * ![20211030210845](https://i.loli.net/2021/10/30/za7Wm82PDiRrews.png)  
* 过程：
  * 假设有r1 r2 两台路由器
  * 问候分组，建立维护邻居关系
  * 然后发送数据库描述分组
  * r1可能就会发现有些链路状态没有
  * 于是发送链路状态请求给r2
  * r2发送链路状态更新分组给r1
  * r1发送链路状态确认分组给R2
  * 其他情况：
    * 30min，或链路状态改变，都会发送链路状态更新分组（洪泛方式）
* 多点接入网络：
  * 如果大家都是邻居问候分组太多了，对每个路由器都要链路状态更新分组显然是没必要的。
  * 诞生了DR指定路由器与BDR备用指定路由器
  *![20211030212006](https://i.loli.net/2021/10/30/RwKNu68fPvVEFYm.png)
* ospf----AS 划分成 区域
  * 特点：具有一个32bit区域标识符
  * 主干区域：0.0.0.0---连同其他区域
  * 路由器数量：<200
  * 作用：洪泛法局限在一个区域内而非是一个AS内，减少通信量。
  * 区域内路由器（IR）||区域边界路由器（abr）||主干路由器（bbr）||自治系统边界路由器（ASBR）
  * 每个区域向主干区域发送区域的链路公告，再从边界路由器接受其他区域的链路公告
***
60.EGP（外部网关协议） 之 BGP边界网关协议
* 要求：能到达目的网络、较好的路由
* 工作原理：
  * BGP发言人：区域边界路由器
    * 各BGP发言人之间在同一个网络
    * 每个自治系统至少一个
    * 既要IGP也要EGP
  * 交换路由信息：
    * 建立tcp连接，端口号179
    * 方式：交换BGP报文----动作名称：BGP会话
    * 内容：增加新的路由、撤销过时路由、报告出错
    * 交换对象：邻站/对等站
* ![20211030215039](https://i.loli.net/2021/10/30/xGjWkiOYtbLSX8d.png)
* ![20211030215239](https://i.loli.net/2021/10/30/rzRwu7NScHY438t.png)
* ![20211030215417](https://i.loli.net/2021/10/30/fCnsQRIkOSzdrVM.png)
  * 一开始交换整个路由表，之后只用更新
***
61. 小练习
封装以下协议报文的协议是：  
* RIP：UDP
* OSPF：IP
* BGP：TCP
* ![20211030215848](https://i.loli.net/2021/10/30/cH2mTUOXjhYK45A.png)
***
62. IPv4数据报首部格式（只是首部） 
* 固定部分：20B
* 可变部分：最大40B（一般不用）
* 字段：4个字节为一个字段，IP数据报以字段为单位。
* 最大长度：受限于最大传输单元（MTU）（以太网帧规定为1500字节）
* ![20211031084018](https://i.loli.net/2021/10/31/qESA2UYDZIrPWJp.png)  
* 固定部分：
  * 版本：通信双方ip协议版本一致。（4B）
  * 首部长度：顾名思义最小为5，最大15（字段为单位）（4B）
  * 区分服务：服务质量（一般也不用，8B）
  * 总长度：IP数据报总长度，可以取到65535，字节为单位（16B）
  * IP数据报分片描述字段：
    * 标识：同一数据报的各分片有相同标识。（计数器产生新IP数据报时+1）（16B）
    * 标志字段：
      * DF：1：允许分片； 0：不允许
      * MF：1：后面还有分片； 0：最后一个分片
      * 保留位：必须为0
    * 片偏移（必须为整数）：  
      数据载荷部分分片后在原数据在和部分的位置（8B为单位）（13B）
  * 生存时间TTL：
    * 255s周期，值减去在路由器耗费的时间，为0丢弃
    * 也可以以跳数为单位
    * 意义：防止IP数据报永久兜圈
  * ![20211031090818](https://i.loli.net/2021/10/31/ysOrRmBXgGCI14b.png)
  * 首部检验和：检验首部在传输过程中是否出错，比CRC简单
    * 每到一个路由器，都要重新计算首部检验和，因为生存时间，片偏移、标志可能会发生变化
    * 耗时，在IPv6中不计算首部检验和
  * 源ip地址 & 目的地址 4B
* 可选字段：长度可变，增加IP数据报的功能，但是也增加路由器处理数据报的开销
* 填充字段：保证首部长度为四字节的整数倍。
***
63. 小练习  
* ![20211031092336](https://i.loli.net/2021/10/31/aJdnseTrbDhYq5N.png)
***
64. ICMP网际控制报文协议  
* 意义：提高交付成功机会、有效转发IP数据报
* 发送差错报告报文、询问报文
* 封装位置：IP数据报
* 差错报告报文：
  * 终点不可达
  * 源点抑制
    * 路由器、主机拥塞而丢弃数据报，向源点发送~~~~报文，让源点把数据报发送速率变慢
  * 时间超过
    * ttl为0，丢弃IP数据报，并且向源点发送~~~~报文
    * 若终点在规定时间内不能收到一个数据报全部数据分片时，也会把已经收到的数据报丢弃，发送时间超过报文
  * 参数问题
    * 根据首部检验和发现传输错误，丢弃，并发送报文
  * 路由改变重定向
    * 通过更好的路由。
* 不发送ICMP差错报告报文的情况：
  * ICMP差错报告报文的差错报告报文 no
  * 第一个分片数据报片后续说有都不发送~~~~~~
  * 多播地址数据报不发送
  * 特殊地址（如127.0.0.0与0.0.0.0）
* ICMP询问报文（2种）：
  * 回送请求和回答
    * 一个主机向另一个主机发出询问，另一个主机发送ICMP回送回答报文
    * 目的：测试目的站是否可达以及状态。
  * 时间戳请求和回答
    * 请求主机，路由器回答当前日期和时间（32位）
    * 进行时钟同步、测量时间
* 应用
  * 分组网间探测ping
    * 测试主机或路由之间的连通性
    * 应用层直接用网际层的ICMP（不经过运输层的TCP，udp）
    * 使用ICMP回送请求和回答报文
  * 跟踪路由
    * 测试IP数据报从源主机到达目的主机经过的路由器
        * windows
          * tracert命令
          * 应用层直接使ICMP
          * 使用ICMP回送请求和差错报告报文
        * unix
          * traceroute
          * udp
          * 只用差错报告报文
    * 过程：
      * 主机发送ICMP回送请求报文TTL分别设置成1,2,3……
      * 路由器会发送时间超过报文
      * 一直到目的主机会发送回送请求回答报文    
***
65. 虚拟专用网VPN 与 网络地址转换NAT
* VPN
  * 利用共用因特网作为专用网之间的通信载体。
  * 虚拟专用网中各主机分配的IP地址应该是本机构可自由分配的专用地址，而非需要申请的在因特网使用的公有地址。
  * IPv4特殊地址(私有地址)---10.0.0.0/8,172.16.0.0/12,192.168.0.0/16
  * 只用于内部通信（本地地址），而不能和因特网的主机通信
  * 因特网中的路由器对目的地址为私有地址的IP数据报不进行转发
  * 传输过程：
    * 有内部IP数据报---专用地址
    * 加密---因特网
    * 外部IP数据报----世界的地址
  * 像一条直通的点对点线路——————成为IP隧道技术
* 网络地址转换NAT
  * 为了缓解IPv4地址被耗尽的问题
  * NAT路由器：装有nat软件的路由器---连接专用网和因特网
    * 有一张NAT转换表，把私有地址，和临时分配的公有地址转换
  * 给私有地址分配一个全球IP地址，然后给公网IP地址
  * 问题：n个IP地址只能给n台主机
* 网络地址与端口转换NAPT
  * 运输层端口号+IP地址 一起转换----一个全球IP地址使多个有本地地址的主机同时和因特网主机通信。
  * ![20211031122334](https://i.loli.net/2021/10/31/HAYIDEg63Km1W2x.png)
  * 注意：外部主机不能首先发起通信，因为napt路由表中没有相应的转换记录。-----因此专用网主机不能直接充当因特网服务器。
    * p2p应用需要外网主机与内网主机进行通信，进行NAT会有问题，需要使用特殊穿越技术。
    * NAT对外网屏蔽内网主机网络地址----内网主机得以保护
66. 小总结  
物理层+数据链路层+网络层----解决异构网络互联---实现**主机到主机**的通信。  
然而真正的通信实体是通信两端主机中的应用进程。
***
67. 运输层！！！！
* 运输层协议 又称 端到端协议！！！！（55555终于!!!期待已久的来了！！！）
* 端口：区分不同应用进程的标识符
* 不同端口 对应 不同的应用进程
* 因特网运输层：
  * 面向连接的TCP
  * 无连接的UDP
***
68. 运输层端口号&复用&分用
* 进程标识符PID----计算机进程----不同操作系统格式不同----需要统一方法对TCP/ip体系的应用进程标识------端口号！！！
* 端口号：16bit----0-65535
  * 熟知端口号：0-1023
    * tcp/ip体系中最重要的应用协议----FTP，21/20；HTTP,80;dns,53
    * 登记端口号：1024-49151
      * 需要登记，防止重复。
    * 短暂端口号：49152-65535 
      * 客户进程暂时使用（动态端口号）通信结束，端口号供其他客户进程使用。
  * 端口号只有本地意义————标识本计算机应用层的各进程，不同计算机相同端口号没有联系。
* 发送方的复用 & 接收方的分用
  * 发送方
    * 应用进程
    * udp复用（数据报） & tcp复用（报文段）
    * IP复用 （数据报）协议字段：6 tcp；17 udp
  * 接收方 
    * 分用 
* ![20211031135317](https://i.loli.net/2021/10/31/FdT7ElxaUi2MI4o.png)  
* 举个例子：
  * dns服务器---web服务器---用户pc  处于一个以太网
  * dns服务器---记录域名对应的IP地址
  * pc中输入域名---pc中dns客户端进程发送dns查询请求报文
  * dns查询请求报文---封装成udp数据报 源端口：在短暂端口号中选 目的端口：53
  * dns服务器看到目的端口为53，将其给dns服务器端进程
  * dns服务器端进程解析报文
  * 发送dns响应报文 udp协议 源端口：53 目的端口：在短暂端口号中选 封装在IP数据报中发送
  * pc端受到，同样根据端口号交给dns客户端进程
  * pc中发送http客户端进程 发送http请求报文 源端口：49152 目的端口：80
  * 同理web服务器中服务端进程发送http响应报文……
* UDP用户数据报协议：无连接
  * 使用UDP协议：
    * 任何一台主机可向其他三台主机发送广播、多播、单播
    * 支持一对一、一对多、一对全
    * 封装方式：直接给应用层报文添加udp首部，去掉应用层报文
      * 不合并，不拆分---面向应用报文
    * 对于丢失和误码----误码通过IP地址中的首部检验和能检测出，接收方会丢弃，但是发送方什么也不做！！！
    * 应用：IP电话、视频会议等实时应用
* TCP传输控制协议：三报文挥手建立连接，四报文挥手建立连接
  * 使用tcp协议：
      * 三报文握手
      * 基于tcp连接的可靠信道
      * 仅支持单播
      * 封装方式：看做一连串比特流，编号--存储在发送缓存+首部
        * 不保证发送数据块的大小==接受数据块的大小。数量
        * 发送和接收方的字节流完全一样
        * 还原成有意义的数据
        * TCP面向字节流---实现可靠传输、拥塞控制、流量控制
        * 全双工通信
        * 不出现误码、丢失、乱序重复
        *应用：文件传输
* ![20211031144139](https://i.loli.net/2021/10/31/3SXQ5vrBReuwypb.png)
* ![20211031144531](https://i.loli.net/2021/10/31/drmyFJLAVKG39Tx.png)  
* ![20211031144934](https://i.loli.net/2021/10/31/pcIjgsNTWm3qdnE.png)
***
68. TCP流量控制
* 意义：数据发送过快，接收方来不及接受，流量控制---接收方来得及接受。
* 滑动窗口机制！！！
  * 首先明确 发送方 和 接收方
  * 发送方 有一个 发送 tcp报文段的长度----一般小于等于滑动窗口大小
  * 接收方 有一个 接受 tcp报文段的长度----滑动窗口大小
  * 发送方 发送seq=1，seq=101（序号）seq=201丢失
  * 接收方 不用逐一确认，而是**累计确认** 
    * ACK=1表示这是一个确认报文段 
    * ack = 201指seq = 201之前的已经接受到了
    * rwnd=300将窗口大小调整为300---即进行流量控制
  * 发送方 接受到 ack
    * 滑动窗口向前滑动
    * 移出窗口的字段可以从缓存区删除
    * 相应的窗口长度调整为300
    * 201-300字段会超时重传
    * 发送301-400，401-500
    * 不能再发送新数据了
  * 接收方 接收到seq 并且发送ACK，调整rwnd = 100
  * 发送方发送
  * 接收方 接收到seq 并且发送ACK，调整rwnd = 0
  * 发送方 不能再发送一般的报文段
* ![20211031153246](https://i.loli.net/2021/10/31/cCq6kXGA41xEJHR.png)  
  * 过了一段时间……
  * 接收方 有 存储空间---接收窗口300---通告主机---丢失
  * 发送方 等待---接收方等待----死锁，怎么解决？？？
  * 发送发在接受到0窗口后，会触发持续计时器，到时间后会发送零窗口探测报文（对此也有个计时器）---仅有1字节
  * 接收方---发送接收窗口长度
  * 如果rwnd = 0----发送方重启持续计时器
  * rwnd ！= 0 死锁打破
  * **注意**：即使rwnd = 0，tcp规定也要接受0窗口探测报文段，确认报文段和紧急数据报文段
  * ![20211031154224](https://i.loli.net/2021/10/31/wLvMClyAf3FjhEW.png)
* 发送窗口大小=min{拥塞窗口，接收窗口}
***
69. tcp拥塞控制
* 网络中某一资源需求超过该资源所能提供的可用部分，网络性能变坏---拥塞---不控制，吞吐量随负荷增大而下降。
* 网络资源：
  * 带宽、交换节点中的缓存、处理机
* ![20211031160012](https://i.loli.net/2021/10/31/UdSk6F5zfbJEeK7.png)
* 理想时是吞吐量和负载量相等
***
70. 拥塞控制算法  
* 假设条件：
  * 数据单方向传送，另一方确认传送。
  * 接收方缓存空间永远足够，即发送方发送窗口仅由网络拥塞程度决定
  * 以最大报文段MSS个数为单位而非字节
* 前情概要：
  * 拥塞窗口cwnd----动态变化---网络拥塞程度
  * 维护原则：没有拥塞，cwnd增大；出现拥塞，cwnd减小
  * 拥塞依据：未按时收到确认报文（发生超时重传）
  * 发送窗口swnd = cwnd
  * 慢开始门限ssthresh：
    * cwnd < ssthresh 使用慢开始算法
    * cwnd > ssthresh 使用拥塞避免算法
    * cwnd = ssthresh 使用两者都可以
* 慢开始
  * 每个传输轮次结束后，拥塞窗口*2
* 拥塞避免
  * 每个传输轮次结束后，拥塞窗口+1
  * 当网络中有几个数据段发生超时重传的时候---判定网络拥塞
    * ssthresh更新为拥塞时，cwnd的一半
    * cwnd = 1，重新执行慢开始算法
* ![20211101093209](https://i.loli.net/2021/11/01/ZRhmdwnqVWo4Asi.png)  
* 但是有时候个别报文段的丢失并不意味着拥塞，（然而cwnd=1，启动慢开始，会使传输效率降低）所以有了快重传和快修复，目的是改进TCP的性能
* 快重传
  * 让发送方尽早知道个别报文段丢失---发送方重传---而非等超时重传计时器超时再重传
  * 接收方---立即确认（能够立即确认的不会累计确认并且不能捎带确认）---收到失序报文段也要对收到的报文段重复确认（是按照顺序发送确认的）（比如2收到，4收到，3丢失，接收方将一直发送2的确认……之后收到3的，会直接发送6的确认（累计确认））。
  * 发送方---3个连续重复确认，立即重传
  * 使网络吞吐量上升20%
  
* 快恢复
  * 收到三个重复确认----不启动慢开始，执行快恢复算法
  * case 1 ：ssthresh 与 cwnd 调整为 当前cwnd 的一半，执行拥塞避免
  * case 2 ：cwnd 增大，等于ssthresh + 3；
    * 发送3个重复确认---有3个数据报文段离开网络---不消耗网络资源
    * 网络中少了3个，拥塞窗口增大
    * ![20211101101913](https://i.loli.net/2021/11/01/h92wxJ3DMmLZuYc.png)
* 小练习
  * ![20211101102425](https://i.loli.net/2021/11/01/Qs9TxCo2f8plnM4.png)

***
71. tcp超时重传
* 超时重传时间不能过长也不能太短
  * 太短，占用不必要网络资源
  * 太长，空闲时间增大、降低传输效率
* 综上，超时重传时间RTO略大于往返时间RTT
* 然而就那么简单吗？
* 传输过程中会遇到许多情况。比如转发过程中有高速率和低速率网络，IP数据报经历的转发路由可能不同
* 解决方法：
  * 利用每次测量得到的rtt样本，计算加权平均往返时间RTTs
  * ![20211101171519](https://i.loli.net/2021/11/01/jRIwAEFNaDWSmPZ.png)
  * 综上，超时重传时间RTO略大于RTTs
* ![20211101172002](https://i.loli.net/2021/11/01/ZzFthkc94mnrM3Q.png)
* 从上述公式可以发现，不管是RTTs还是最终的RTO都与每一次测得的RTT相关。
* 但是测RTT是比较困难的
* ![20211101172600](https://i.loli.net/2021/11/01/hpRBj74bJ5gmnLv.png)  
* 出现超时重传————无法测RTT
* 解决方法：
  * 只要报文段重传，不采用其RTT样本————不重新计算RTTs和RTO
    * 导致的新问题：
      * 万一报文段时延突然增加，并维持一段时间，那么因为确认还没等到，于是就会重传报文段。但……这一重传导致重传时间并不更新……于是一直重传
  * 所以，Karn算法修正，每次重传，RTO增大一些，RTO = 2 * RTO
*** 
72. TCP可靠传输
* 实现方式：以**字节***为单位的滑动窗口
* 例如：
  * 接收方向发送方发送rwnd = 20，ack = 31，表明滑动窗口大小为20，并且接下来希望收到31号报文段
  * 发送窗口前沿：当前不允许发送的字段
    * 移动情况：
      * 向前：收到确认向前移动
      * 不动：发送窗口减小，滑动窗口向前移动，恰巧移动距离等于发送窗口减小的大小
      * 向后（不推荐）可能已经有在前沿附近的数据发送出去了，会产生错误
  * 后沿：当前已经发送并收到确认可以删除的字段
    * 移动情况：
      * 不动
      * 向前移动
  * ![20211102082550](https://i.loli.net/2021/11/02/NSiARtWKzsToyEu.png)
  * 注意事项：
    * 发送方的发送窗口不一定总是和接收窗口一样大
       * 发送方还有个拥塞状态需要确认（取更小的那个）
       * 接收方发送的窗口值相对于发送方收到有一定的时间滞后
    * 不按时到达的数据TCP无明确规定
      * 若一律丢弃：会有许多超时重传的数据
      * 通常：不按序到达的数据临时存放在接受窗口，收到缺失的字节后，再按序交付上层应用进程
    * tcp接收方有累计确认和捎带确认机制
      * 接收方可以在自己有数据需要发送时把确认信息顺便捎带上。
        * 接收方不能过分推迟发送确认，否则会引起超时重传。
        * 确认推迟时间<=0.5s，收到一连串具有最大长度的报文段，每隔一个报文段就发送一个确认。
        * 捎带确认很少发生，因为大多应用程序很少同时在两个方向上发送数据
    * TCP为全双工通信，每一方都有发送窗口和接收窗口
*** 
73. TCP运输的连接
* 面向连接
* 每次连接建立和释放
* 解决问题：
  * 双方能知道对方的存在
  * 协商参数————最大窗口值、窗口扩大时间戳服务质量……不太理解
  * 能能够对运输实体资源（缓存、链接表中的项目）分配（也不太理解）
* 过程：

||客户端|服务器端| 
| :----: | :----:|:----:|
||关闭|关闭|
|||创建传输控制块
|||监听（被动等待连接请求）
||创建传输控制块|监听
||发送tcp连接请求报文段（首部SYN=1，seq为初始序号）|监听
||进入同步已发送状态|
|||收到并同意连接--发送tcp连接请求确认报文段
|||进入同步已接收状态
||收到并发送tcp确认报文段|
||进入连接已建立状态|
|||收到并进入连接已建立状态


* 传输控制块：
  * TCP连接表
    * 指向发送和接收缓存的指针
    * 指向重传队列的指针
    * 当前发送接受序号
* **客户端tcp连接请求报文段**：SYN=1 的报文段不能携带数据，但是要**消耗**一个序号seq=x
* 客户端：主动打开连接；服务端：被动打开连接
* **服务端tcp连接请求确认报文段**：SYN = 1，ACK=1，seq=y（初始值），ack = x+1（对于之前客户端进程所选择的初始序号的确认，不携带数据）
* **客户端确认报文段**：该报文段可以携带数据，如果没有携带数据，那么**不消耗**序号，下一个发送的ACK=1，seq = x+1（第一次确认时为x，并且不携带数据，只有一字节），ack = y+1（tcp服务器端选择的初始序号的确认）
* tcp对于有字节的数据必须进行确认，而ack本质上是没有数据的，因此tcp不会因为这个ack而超时重传
* Q:为什么不能是两次握手呢？
* A：能够有效防止失序的报文段突然到达而产生的错误。（两次握手）
* ![20211103084911](https://i.loli.net/2021/11/03/PtvNuS1HklnFW72.png)
* ![20211103091937](https://i.loli.net/2021/11/03/WCNOhMBdtbqTgsp.png)
* 综上，我想说的是关键在于同步的初始序列号+对方的确认，并且是双方的同步序列都确认才行
***
74. tcp连接释放
* tcp通信双方都可以释放连接
* FIN和SYN一样，即使不携带信息，也要消耗掉一个序号
* MSL最长报文段寿命：2min
* 时间等待：防止最后一个客户端发的确认报文段在途中丢失了，服务器端一直超时重传；也保证所有报文段都消失
* 保活计时器：
  * 目的：
    * 如果客户端发生了故障，并且连接已经建立，那么不能让服务器一直等待。
  * 设置方式：
    * 发送一个报文段后的2小时如果没再收到数据报文段。
    * 发送一个探测报文段，每隔75s，共十个，如果没有响应---关闭连接。
* 具体图：
  * ![20211104082529](https://i.loli.net/2021/11/04/s7ADbwuf9S1dLvY.png)
***
75. tcp报文段首部格式
* tcp---面向字节流
* 发送数据---缓存取一部分或全部字节添加一个首部----成为tcp报文段
* tcp报文段首部格式
  * ![20211104085413](https://i.loli.net/2021/11/04/GI2i7kHEdm6UgeB.png)
  * 源端口：标识发送tcp报文段的应用进程
  * 目的端口：接受报文段的应用进程
  * 序号字段：0-2<sup>32</sup>-1,序号增加到最后，下一个为0
    * 指出tcp报文段数据载荷的第一个字节序号
  * 确认号字段：0-2<sup>32</sup>-1,序号增加到最后，下一个为0
    * 期望收到对方下一个tcp报文段数据载荷的第一个序号 
    * 对之前所有数据的确认
    * ACK值为1时，确认字段有效
    * tcp连接建立后，所有tcp报文段都必须把ACK设为1
  * 数据偏移：tcp数据载荷的起始位置距离tcp报文段起始处有多远
    * 指出tcp报文段首部长度
    * 数据偏移最小值（0101）<sub>2</sub>最大（1111）<sub>2</sub>
  * 保留字段：今后使用，目前为0
  * 窗口：
    * 发送本报文段的一方的接收窗口
    * 接收方让发送方设置其发送窗口的依据---流量控制
    * 发送窗口：min（接收窗口，拥塞窗口）
  * 校验和：
    * 检测范围tcp报文段首部+数据载荷
    * 检测是否误码 （与udp类似，需要添加12字节伪首部）
  * 同步标志位SYN：同步序号
    * SYN为1：为tcp请求报文段或者是tcp请求确认报文段
  * 终止标志位FIN：释放tcp连接  
  * 复位标志位RST：复位TCP连接
    * rst=1，tcp连接出现异常，必须释放连接，重新建立连接
    * rst =1 拒绝非法报文段，拒绝打开一个tcp连接。
  * 推送标志PSH：
    * psh=1，接收方尽快上交应用进程，不必等到缓存满了之后在向上交付
  * 紧急标志位urg+紧急指针（urg=1有效）
    * 发送方：紧急数据插队到发送缓存最前面---立即发送
    * 接收方：立即上交
    * 紧急指针：数据载荷包含多长的紧急数据，之后是普通数据
  * ![20211104091923](https://i.loli.net/2021/11/04/P7MWUtSBvDcROxb.png)
  * 填充：确保报文段首部能被4整除--以4字节为单位

* 举例：
  * 浏览器输入域名---浏览器进程构建封装有http请求报文的tcp报文段
  * 源端口号：49152 目的端口：80
  * 根据目的端口号80---转交给web服务器端进程
  * 服务端构建http响应报文：目的口号：49152 源端口：80
  * 浏览器进程收到--解析--显示
***
76. 应用层
* 万维网应用www
  * 应用层协议：超文本传送协议HTTP
* 域名系统DNS：域名---IP地址
* 动态主机配制DHCP
* 电子邮件
* 文件传送FTP
* P2P文件共享
* 多媒体网络应用
***
77. 客户/服务器方式(C/S)和对等方式(P2P)
* 目的：网络上应用程序的组织方式和联系
* 客户/服务器方式（C/S)
  * 客户：服务请求方
  * 服务器：服务提供方
    * 总是处于运行状态，等待客户的服务请求---服务器有固定端口号（如http服务器默认端口号80），运行服务器主机也有固定IP地址
  * 应用： 
    * www
    * 电子邮件
    * ftp
  * 服务集中性：应用服务集中在比客户计算机少的多的服务器计算机上
  * 服务器计算机跟不上客户机请求。
  * 常用计算机群集（服务器场）构建虚拟服务器（不太理解）
* P2P方式
  * 没有固定服务请求和提供者，对等方直接通信
  * P2P文件共享、即时通信、P2P流媒体、分布式存储
  * 服务分散型
  * 系统性能不会因规模扩大而降低
  * 具有成本优势
* ![20211104131141](https://i.loli.net/2021/11/04/l4CjSsO9LqeMi78.png)
***
78. 动态主机配置协议DHCP   
* 开机启动DHCP---获取网络配置信息
* 应用层协议---使用UDP所提供的服务
* 服务器端口：67
* 客户端口：68
* 过程：
  * 客户机：
    *源地址0.0.0.0（还未被分配IP地址）
    * 目的地址：255.255.255.255 ---广播**dhcp发现报文**
      * 主机不知道网络中有几个DHCP服务器，以及它们的IP
      * DHCP发现报文：封装有客户端MAC地址、事物ID
    * 对于其他客户机，收到了之后，由于**没有监听UDP用户数据报目的端口67**的进程---丢弃
  * 服务机始终运行---接收报文段
    * 针对客户端MAC地址查找配置信息
      * 有，提供信息构建并发送**DHCP提供报文**
      * 没有，默认信息~~~~~~~~~~~~~~~~~~
    * 源IP地址：服务器IP地址
    * 目的地址：广播地址
    * 其他服务机没有端口68，因此丢弃
    * DHCP提供报文：
      * 封装信息：
        * 事务ID
        * 配置信息：IP地址、子网掩码、地址租期、默认网关、DNS服务器
            * IP地址配置时使用ARP确保所选IP地址未被网络中其他主机占用
  * 客户机：
    * 根据事物ID来判断是否是自己发送的报文
    * 对于多个服务机发来的报文，哪个先到取哪个
    * 发送**DHCP请求报文**
      * 源地址：0.0.0.0（需要征求服务器同意，由于有多个服务器抛橄榄枝，所以dns自己也不知道客户机会不会选它）
      * 目的地址：广播地址（因为DHCP需要得到回复，如果单播则要一个个告诉）
      * 事物ID
      * 接受租约中的IP地址
      * 提供租约的DHCP服务端的IP地址
  * 服务机：
    * 发送**DHCP确认报文**
  * 客户机：
    * 租用之前，使用ARP检测所分配到的IP地址是否已被其他主机占用
      * 被占用：发送dhcp decline（谢绝）报文---撤销租约
      * 未占用：使用租约IP地址
    * 租期过了一半时，会向dhcp服务器发送**DHCP请求报文**
      * 该报文源地址：租用的IP地址；目的地址：DHCP服务器
  * 服务机：
    * 发送dhcp确认报文---客户机可以得到新的租用期
    * 不同意 发送dhcp NACK报文---客户机立即停止使用租用的IP地址，重新发送DHCP dicover报文
    *未响应---客户机在0.875租用期时再次请求
  * 客户机：
    * 可以随时提前终止租用期---发送DHCP释放报文段
* DHCP中继代理：
  * 因为广播（DHCP discover报文）碰到路由会被丢弃。
  * 解决方法：
    * 该路由器的IP地址 = DHCP服务器IP地址----路由成为DHCP中继代理
    * 路由收到广播---单播DHCP dicover发给DHCP服务器
    * 不用每个网络上都设一个DHCP服务器
***
79. 文件传送协议FTP
* 交互式访问---客户指明文件类型和格式，并允许文件有存取权限
* FTP---C/S方式
* 应用：批量传输文件；网站内容文件商场到web服务器
* FTP熟知端口号：21----传送控制命令的TCP连接----客户端：随机端口号
* 服务----客户
  * FTP熟知端口号：20----客户端：另一个随机端口号---传送文件（主动模式，服务器主动连接客户）
* 客户---服务
  * FTP客户通过命令通道告知FTP服务器开启某个**临时端口**被动等待TCP连接，建立数据通道（被动模式
* 总结：两个连接
  * 控制连接---整个会话期间一直打开，传送ftp控制命令
  * 数据连接---用于文件传输，每次传输时建立，结束关闭
***
80. 域名系统dns
1. 主机在dns高速缓存查找域名对应IP
2. 如果没找到---向dns服务器查询
3. dns服务器：域名---IP地址一一映射，查询结果发送主机
4. 主机通过IP地址，对Web服务器中的IP地址进行访问
* 理论上可以只有一台DNS服务器，但是如果dns服务器故障会导致整个因特网瘫痪。
* 层次结构的命名树---主机名（域名）---使用分布式的域名系统dns
* dns使大多数域名在本地解析，少量解析需要在因特网上通信，因此系统效率高  
**层次树状结构的 域名结构**    
若干个分量，各分量之间用点割开，表示不同级别域名。  
级别从左到右逐渐增高  
完整域名不超过255个字符。 
不规定一个域名有多少下级域名，不规定每一级域名意思，各级域名尤其上一级的域名管理机构管理，最高域名由因特网名称与数字地址分配机构ICANN管理。  
* 域名系统（domain name system）
  * 顶级域名（TLD）
    * 国家顶级域名nTLD cn，us，uk
    * 通用顶级域名gTLD com，net，org，int，edu，gov，mil
    * 反向域arpa 反向域名解析---IP地址反向解析为域名
    * 国家顶级域名下注册的二级域名由国家自行决定
    * 中国二级域名：
      * ![20211108132803](https://i.loli.net/2021/11/08/zeC8vHTjWoR73LZ.png)
    * DNS 使用**分布在各地的域名服务器**来实现域名到IP地址的转换
    * 域名服务器----4种：
      * 根域名服务器 
        * 有13个不同IP地址的根域名服务器
        * 一台服务器是由许多计算机构成的服务器群集。
        * 每个服务器都知道所有顶级域名服务器的域名+IP地址
        * 不直接对域名进行解析，而是返回该域名所属顶级域名服务器的IP地址。
      * 顶级域名服务器
        * 管理在该顶级域名服务器注册的所有二级域名
        * 可能是最后的结果，可能是下一级权限域名服务器的IP地址
      * 权限域名服务器
        * 负责管理某个区的域名，每个主机域名都必须在某个权限域名服务器处注册登记。
      * 本地（默认）域名服务器
        * 不属于上述服务器的等级结构
        * 代理作用，会将报文转发到上述域名服务器等级结构中。
        * 本地域名服务器IP地址直接配置在需要域名解析的主机中。
    * ![20211108140311](https://i.loli.net/2021/11/08/OSxPyusAVnYMRd3.png)
* 域名解析过程
  * 递归查询
  * ![20211108151521](https://i.loli.net/2021/11/08/nEHawfVKY1b8G9q.png)
  * 迭代查询
    * 每次求得下一个要访问的域名服务器并直接返回给源服务器，源服务器。
    * 
* 高速缓存：
  * 意义：本地域名服务器---提高查询效率---存放最近查询过的域名+IP地址
  * 域名---IP地址映射并非永久不变---计时器，每个项目两天存放
  * 用户主机在启动时就从本地域名服务器下载域名+IP地址的全部数据。主机也需要保持高速缓存中内容正确性
* 迭代过程：www不用迭代查询
  * ![20211108155005](https://i.loli.net/2021/11/08/QlRXZi9mh7EqUDz.png)
* DNS报文---运输层udp协议---端口号：53
***
81. 电子邮件  
* 过程：
  * 发件人将邮件发到自己的邮件服务器
  * 邮件服务器按目的地址发送到收件人邮件服务器的收件人邮箱。
  * 收件人访问邮件服务器的邮箱收到电子邮件
* C/S方式
* 主要组件：
  * 用户代理：用户和电子邮件的接口---电子邮件客户端软件。
  * 邮件服务器：发送和接受邮件，维护用户邮箱。
  * 电子邮件协议：发送协议（SMTP）读取协议（POP3，IMAP）
  * ![20211109092852](https://i.loli.net/2021/11/09/RCFulsyaXvMSAjr.png)
* 具体实现过程：
  * 发送方：14条SMTP命令
  * 接收方：21种SMTP应答
  * 基于TCP连接 端口号：25
  * TCP连接成功：接收方主动推送服务就绪应答
  * ![20211109094245](https://i.loli.net/2021/11/09/PfDGY47nICHwihO.png)  
* 电子邮件信息格式
  * 信封和内容
  * 内容：首部和主体
* SMTP协议传送内容
  * ASCII码文本数据，不能传送可执行文件或其他二进制对象
  * 即图片音视频都不能，中文俄文都不行
* 解决方法：
  * MIME：多用途因特网邮件拓展（也用于HTTP）
  * ![20211109095411](https://i.loli.net/2021/11/09/oFi9qfEKyLD4eRC.png)
* 读取协议
  * ![20211109095705](https://i.loli.net/2021/11/09/2ECpymiv6SLBDHV.png)
  * 通过浏览器登录---与IMAP相似，不需要专门的用户代理程序
  * ![20211109095926](https://i.loli.net/2021/11/09/9MNEUXFqrY1HdGy.png)
***
82. 万维网www---运行在因特网上的分布式应用
* 超链接---构成信息网
* 渲染引擎---浏览器内核---网页内容解析显示
* ![20211110150129](https://i.loli.net/2021/11/10/WkSAZOqLwm3687z.png)
* 统一资源定位符URL----指明资源位置
  * 协议://主机：端口/路径
* http超文本传输协议
  * 客户进程---浏览器怎样向万维网服务器请求万维网文档，万维网服务器怎样把文档传送给浏览器
  * http请求报文，响应报文
    * http1.0
    * ![20211110151230](https://i.loli.net/2021/11/10/ZjJBtY93Tu8DbGr.png)
    * http1.1
    * ![20211110151324](https://i.loli.net/2021/11/10/vYKgZh8sVroaqId.png)
  * cookie http请求报文---cookie码---每次访问携带cookie 码
  * 万维网缓存==代理服务器
    * 可以在客户机、中间
  * ![20211110153130](https://i.loli.net/2021/11/10/ugYwtEx3oc8OhqH.png)




    






